---
title: "World Cup Squads"
author: "Arthur Gymer"
date: "2019-09-10"
categories: ["Rugby", "World Cup", "R"]
tags: ["World Cup"]
output: html_document
---

```{r setup, include=FALSE}
data_root <- '../../../data/'
knitr::opts_knit$set(root.dir = data_root)
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(ggplot2)
library(kableExtra)
```

## A (very) Brief History

It took 116 years from the first test match but in 1987 the inaugural Rugby World Cup kicked off in the storied Eden Park; New Zealand dismantling Italy in front of 20,000 fans. Making up the invitation-only field were 16 teams of totally amateur players, almost all of whom played their club rugby on home soil.

In the intervening 32 years rugby has seen massive and rapid change; the advent of professionalism in 1995 sending shockwaves through the sport, from which some would argue it has never recovered.

But the genie is out of the bottle and there is no looking back. With more money flowing into the game year-on-year, and players seemingly ever-increasing in size, the demands of the game have changed.

So, inspired by [this reddit post](https://www.reddit.com/r/rugbyunion/comments/d0268r/ruwc_2019_teams_with_average_age_and_total_caps/?ref=share&ref_source=link) I decided to take a look at every squad ever sent to the World Cup and how they have changed in 3 decades.


## The Data

The bulk of the squad data were scraped from Wikipedia pages for Rugby World Cup Squads found at `https://en.wikipedia.org/wiki/YYYY_Rugby_World_Cup_squads`. 

Some missing caps data and all test match data were scraped from ESPN Scrum's [Statsguru](http://stats.espnscrum.com/statsguru/rugby/stats/index.html)

All scraping was done in `python` using `pandas` and `beautifulsoup`.

```{r "data-prep", echo = F}
sqds <- fread('wc_squads_processed.csv')
tests <- fread('all_matches_83_19.csv')

tier_1 <- c(
  "Argentina", "Australia", "England", "France", "Ireland", "Italy",
  "New Zealand", "Scotland", "South Africa", "Wales"
)
tier_2 <- c(
  "Canada", "Fiji", "Georgia", "Japan", "Namibia", "Portugal",
  "Romania", "Russia", "Samoa", "Spain", "Tonga", "United States", "Uruguay"
)

tier_cols <- list(
  muted = list("#95c292", "#9295c2", "#c29295"),
  dark = list("#2c8626", "#262c86", "#86262c"),
  brewer = list("#1b9e77", "#7570b3", "#d95f02")
)

sqds[country == 'Western Samoa', country := 'Samoa']
sqds[flag == 'Georgia (country)', flag := 'Georgia']
sqds[club == '', club := 'unknown']
sqds[club == 'Unattached', club := 'none']

sqds[country %in% tier_2, tier := 2]
sqds[country %in% tier_1, tier := 1]
sqds[is.na(tier), tier := 3]

tests[team %in% tier_1, tier := 1]
tests[team %in% tier_2, tier := 2]
tests[is.na(tier), tier := 3]

```

## The Teams

```{r "overview", echo=F}
played <- data.table(as.data.frame.matrix(table(unique(sqds[, .(country, year)]))), keep.rownames = T)
played[, tot:=sum(.SD[]), .SDcols = c('1987', '1991', '1995', '1999', '2003', '2007', '2011', '2015', '2019'), by=rn]
setnames(played, c('rn', 'tot'), c('Country', 'Total'))
played <- played[unique(sqds[,.(country,tier)]), on=c(Country='country')]
played <- played[order(-Total, -`1987`, -`1991`, -`1995`, -`1999`, -`2003`, -`2007`, -`2011`, -`2015`, -`2019`, tier)]
```

Since that first game `r nrow(played)` nations have competed in at least 1 World Cup. `r nrow(played[Total==9])` of those teams have turned out for every iteration; South Africa the biggest name missing from the list, with anti-apartheid sporting boycotts keeping them away from the '87 and '91 events. Samoa (or Western Samoa as they were then) can feel hard-done by to not make the cut, having been snubbed from the invite-only 1987 showpiece.

```{r "tournament-table", echo=F}
mk_icon <- function(x) {ifelse(x==1, '<span class="glyphicon glyphicon-ok"></span>', '')}
year_cols <-  c('1987', '1991', '1995', '1999', '2003', '2007', '2011', '2015', '2019')
played_fmt <- copy(played)
played_fmt <- played_fmt[ ,(year_cols) := lapply(.SD, mk_icon), .SDcols=year_cols]
kable(played_fmt[,-c('tier')], format= 'html', escape = FALSE) %>%
  kable_styling(full_width = T) %>%
  row_spec(which(played[,tier]==1), background = tier_cols[["muted"]][[1]]) %>%
  row_spec(which(played[,tier]==2), background = tier_cols[["muted"]][[2]]) %>%
  row_spec(which(played[,tier]==3), background = tier_cols[["muted"]][[3]])
```

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"><thead><tr>
<th style="background: `r tier_cols[["muted"]][[1]]`">Tier 1</th>
<th style="background: `r tier_cols[["muted"]][[2]]`">Tier 2</th>
<th style="background: `r tier_cols[["muted"]][[3]]`">Tier 3</th>
</tr></thead></table>

Whilst there was representation from Zimbabwe and Ivory Coast at the early editions, it's notable that since the dawn of professionalism - even with the field growing from 16 to 20 teams - no Tier 3 team has taken part. 

Since we were inspired by a simple look at the average number of caps and age, let's start there.

Figure \ref{fig:cap-box} shows that there is a clear trend towards players with more caps in World Cup squads. The median caps rose steadily from 1987 before starting to level off between 2015-19, whilst there was a noticeable bump in the upper bound of the interquartile range from 2007. This suggests that even though the outliers, the McCaw's and O'Driscoll's, are reaching cap numbers nearly double the highest in 1987, they are not the only reason for the average increase; the average player is also becoming more capped.

```{r "cap-box", echo = F, warning = F}
cap_bplot <- (
  ggplot(sqds, aes(x=as.factor(year), y=caps)) + 
    geom_boxplot() +
    labs(x = "Year", y = "Caps") +
    theme_bw()
)
cap_bplot
```

So what is the cause of this increase? A pressing issue in World Rugby lately has been player welfare, with many leading players pushing for fewer games amid ever-more crowded international and domestic calendars. Is the average World Cup attendee more capped simply because there are more tests played in 2019?

Figure \ref{fig:number-tests} shows the number of tests per year played by every nation from the decade before the inaugural World Cup.

```{r "number-tests", echo = F}
tests[, sum(total_matches)/2, by=year]

n_tests_jitt <- (
  ggplot(tests, aes(x=year, y=total_matches, colour=as.factor(tier))) + 
    geom_count(position='jitter') + 
    geom_smooth() + 
    geom_smooth(aes(group=1), colour = "black") + 
    scale_colour_manual(values=tier_cols[["dark"]]) + 
    theme_bw()
)
```